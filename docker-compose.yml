services:
  # Service Nginx
  nginx:
    image: nginx:1.25-alpine
    container_name: restaurant_nginx
    ports:
      - "9000:80"
    volumes:
      - .:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - app
    networks:
      - restaurant_network

  # Service PHP/Symfony
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: restaurant_app
    volumes:
      - .:/var/www/html
      - ./var/log:/var/www/html/var/log
    environment:
      - APP_ENV=dev
      - DATABASE_URL=mysql://restaurant_user:restaurant_pass@mysql:3306/restaurant_db
      - MONGODB_URL=mongodb://admin:password@mongo:27017/restaurant_mongo?authSource=admin
      - MONGODB_DB=restaurant_mongo
    depends_on:
      - mysql
      - mongo
    networks:
      - restaurant_network

  # Service MySQL (existant)
  mysql:
    image: mysql:8.0.35
    container_name: restaurant_mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: restaurant_db
      MYSQL_USER: restaurant_user
      MYSQL_PASSWORD: restaurant_pass
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - restaurant_network

  # Service MongoDB (nouveau)
  mongo:
    image: mongo:7.0.4
    container_name: restaurant_mongo
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: restaurant_mongo
    volumes:
      - mongo_data:/data/db
      - ./docker/mongo/init.js:/docker-entrypoint-initdb.d/init.js
    networks:
      - restaurant_network

  # Service MongoDB Express (interface web)
  mongo-express:
    image: mongo-express:1.0.2-20
    container_name: restaurant_mongo_express
    ports:
      - "8082:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    depends_on:
      - mongo
    networks:
      - restaurant_network

  # Service phpMyAdmin (interface MySQL)
  phpmyadmin:
    image: phpmyadmin:5.2.1-fpm-alpine
    container_name: restaurant_phpmyadmin
    ports:
      - "8083:80"
    environment:
      PMA_HOST: mysql
      PMA_USER: restaurant_user
      PMA_PASSWORD: restaurant_pass
    depends_on:
      - mysql
    networks:
      - restaurant_network

volumes:
  mysql_data:
  mongo_data:

networks:
  restaurant_network:
    driver: bridge
